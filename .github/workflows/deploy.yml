name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'my-blog-cms/**'
      - 'laqta/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_strapi:
        description: 'Deploy Strapi CMS'
        type: boolean
        default: true
      deploy_laqta:
        description: 'Deploy Next.js Frontend'
        type: boolean
        default: true

env:
  STRAPI_PATH: /var/www/laqta-project/my-blog-cms
  LAQTA_PATH: /var/www/laqta-project/laqta

jobs:
  deploy-strapi:
    name: Deploy Strapi
    runs-on: ubuntu-latest
    environment: production
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_strapi)

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'my-blog-cms/package-lock.json'

      - name: Install Dependencies
        working-directory: ./my-blog-cms
        run: |
          echo "=========================================="
          echo "ðŸ“¦ Installing Strapi dependencies..."
          echo "=========================================="
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo ""
          npm ci
          echo ""
          echo "âœ… Dependencies installed successfully"

      - name: Build Strapi
        working-directory: ./my-blog-cms
        run: |
          echo "=========================================="
          echo "ðŸ”¨ Building Strapi admin panel..."
          echo "=========================================="
          npm run build
          echo ""
          echo "âœ… Strapi build completed successfully"

      - name: Package Artifacts
        run: |
          echo "=========================================="
          echo "ðŸ“ Packaging Strapi for deployment..."
          echo "=========================================="
          mkdir -p pkg

          echo "â†’ Copying build directory..."
          cp -r my-blog-cms/build pkg/ 2>/dev/null && echo "  âœ“ build/ copied" || echo "  âš  build/ not found (skipped)"

          echo "â†’ Copying dist directory..."
          cp -r my-blog-cms/dist pkg/ 2>/dev/null && echo "  âœ“ dist/ copied" || echo "  âš  dist/ not found (skipped)"

          echo "â†’ Copying config, public, src directories..."
          cp -r my-blog-cms/config my-blog-cms/public my-blog-cms/src pkg/
          echo "  âœ“ config/, public/, src/ copied"

          echo "â†’ Copying package files..."
          cp my-blog-cms/package.json my-blog-cms/package-lock.json pkg/
          echo "  âœ“ package.json, package-lock.json copied"

          echo "â†’ Copying tsconfig.json..."
          cp my-blog-cms/tsconfig.json pkg/ 2>/dev/null && echo "  âœ“ tsconfig.json copied" || echo "  âš  tsconfig.json not found (skipped)"

          echo ""
          echo "â†’ Creating tarball..."
          tar -czf strapi.tar.gz -C pkg .

          echo ""
          echo "ðŸ“Š Package contents:"
          ls -la pkg/
          echo ""
          echo "ðŸ“¦ Archive size: $(du -h strapi.tar.gz | cut -f1)"
          echo ""
          echo "âœ… Packaging completed successfully"

      - name: Setup SSH Connection
        run: |
          echo "=========================================="
          echo "ðŸ” Setting up SSH connection..."
          echo "=========================================="
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "â†’ Scanning host keys for ${{ secrets.VPS_HOST }}..."
          ssh-keyscan -H -p ${{ secrets.VPS_SSH_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "âœ… SSH configured successfully"

      - name: Upload to VPS
        run: |
          echo "=========================================="
          echo "ðŸ“¤ Uploading Strapi package to VPS..."
          echo "=========================================="
          echo "â†’ Target: ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/"
          echo "â†’ Port: ${{ secrets.VPS_SSH_PORT || 22 }}"
          echo ""
          scp -v -P ${{ secrets.VPS_SSH_PORT || 22 }} strapi.tar.gz ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/
          echo ""
          echo "âœ… Upload completed successfully"

      - name: Deploy on VPS
        run: |
          echo "=========================================="
          echo "ðŸš€ Deploying Strapi on VPS..."
          echo "=========================================="
          ssh -p ${{ secrets.VPS_SSH_PORT || 22 }} ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          DEPLOY_PATH="/var/www/laqta-project/my-blog-cms"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 1: Backup environment file"
          echo "=========================================="
          if [ -f "$DEPLOY_PATH/.env" ]; then
            cp "$DEPLOY_PATH/.env" /tmp/.env.bak
            echo "âœ… .env backed up to /tmp/.env.bak"
          else
            echo "âš  No .env file found (first deployment?)"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 2: Prepare deployment directory"
          echo "=========================================="
          echo "â†’ Creating directory: $DEPLOY_PATH"
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          echo "â†’ Current directory: $(pwd)"
          echo "â†’ Cleaning old files (preserving node_modules and .env)..."
          find . -mindepth 1 -maxdepth 1 ! -name 'node_modules' ! -name '.env' -exec rm -rf {} +
          echo "âœ… Directory cleaned"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 3: Extract new files"
          echo "=========================================="
          echo "â†’ Extracting strapi.tar.gz..."
          tar -xzf /tmp/strapi.tar.gz
          echo "âœ… Files extracted"
          echo ""
          echo "ðŸ“‚ Deployed files:"
          ls -la

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 4: Restore environment file"
          echo "=========================================="
          if [ -f /tmp/.env.bak ]; then
            mv /tmp/.env.bak .env
            echo "âœ… .env restored"
          else
            echo "âš  No .env backup to restore"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 5: Install production dependencies"
          echo "=========================================="
          echo "â†’ Running npm ci --only=production..."
          npm ci --only=production
          echo "âœ… Dependencies installed"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 6: Restart PM2 process"
          echo "=========================================="
          if pm2 describe strapi > /dev/null 2>&1; then
            echo "â†’ Strapi process found, restarting..."
            pm2 restart strapi
            echo "âœ… Strapi restarted"
          else
            echo "â†’ Strapi process not found, starting new..."
            pm2 start npm --name "strapi" -- run start
            echo "âœ… Strapi started"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 7: Save PM2 process list"
          echo "=========================================="
          pm2 save
          echo "âœ… PM2 process list saved"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 8: Cleanup"
          echo "=========================================="
          rm /tmp/strapi.tar.gz
          echo "âœ… Temporary files cleaned"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 9: Verify deployment"
          echo "=========================================="
          echo "â†’ PM2 status:"
          pm2 status
          echo ""
          echo "â†’ Waiting 10 seconds for Strapi to start..."
          sleep 10
          echo "â†’ Checking Strapi health endpoint..."
          if curl -sf http://localhost:1337/api/health > /dev/null; then
            echo "âœ… Strapi is healthy and responding!"
          else
            echo "âš  Health check failed (Strapi may still be starting)"
            echo "â†’ Recent PM2 logs:"
            pm2 logs strapi --lines 20 --nostream || true
          fi

          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ STRAPI DEPLOYMENT COMPLETED!"
          echo "=========================================="
          EOF

  deploy-laqta:
    name: Deploy Next.js
    runs-on: ubuntu-latest
    needs: deploy-strapi
    if: |
      always() &&
      (needs.deploy-strapi.result == 'success' || needs.deploy-strapi.result == 'skipped') &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.deploy_laqta))
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'laqta/package-lock.json'

      - name: Install Dependencies
        working-directory: ./laqta
        run: |
          echo "=========================================="
          echo "ðŸ“¦ Installing Next.js dependencies..."
          echo "=========================================="
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo ""
          npm ci
          echo ""
          echo "âœ… Dependencies installed successfully"

      - name: Build Next.js
        working-directory: ./laqta
        run: |
          echo "=========================================="
          echo "ðŸ”¨ Building Next.js application..."
          echo "=========================================="
          echo "â†’ NEXT_PUBLIC_STRAPI_URL_2: $NEXT_PUBLIC_STRAPI_URL_2"
          echo ""
          npm run build
          echo ""
          echo "âœ… Next.js build completed successfully"
        env:
          NEXT_PUBLIC_STRAPI_URL_2: ${{ secrets.NEXT_PUBLIC_STRAPI_URL_2 }}

      - name: Package Artifacts
        run: |
          echo "=========================================="
          echo "ðŸ“ Packaging Next.js for deployment..."
          echo "=========================================="
          mkdir -p pkg

          if [ -d "laqta/.next/standalone" ]; then
            echo "â†’ Standalone output detected (optimized build)"
            echo "â†’ Copying standalone build..."
            cp -r laqta/.next/standalone/* pkg/
            echo "  âœ“ standalone/ copied"

            echo "â†’ Creating static and public directories..."
            mkdir -p pkg/.next/static pkg/public

            echo "â†’ Copying static files..."
            cp -r laqta/.next/static/* pkg/.next/static/
            echo "  âœ“ .next/static/ copied"

            echo "â†’ Copying public files..."
            cp -r laqta/public/* pkg/public/ 2>/dev/null && echo "  âœ“ public/ copied" || echo "  âš  public/ empty or not found"
          else
            echo "â†’ Standard output detected (non-standalone build)"
            echo "â†’ Copying .next directory..."
            cp -r laqta/.next pkg/ 2>/dev/null && echo "  âœ“ .next/ copied" || echo "  âš  .next/ not found"

            echo "â†’ Copying public directory..."
            cp -r laqta/public pkg/ 2>/dev/null && echo "  âœ“ public/ copied" || echo "  âš  public/ not found"

            echo "â†’ Copying package files..."
            cp laqta/package.json laqta/package-lock.json pkg/
            echo "  âœ“ package.json, package-lock.json copied"
          fi

          echo ""
          echo "â†’ Creating tarball..."
          tar -czf laqta.tar.gz -C pkg .

          echo ""
          echo "ðŸ“Š Package contents:"
          ls -la pkg/
          echo ""
          echo "ðŸ“¦ Archive size: $(du -h laqta.tar.gz | cut -f1)"
          echo ""
          echo "âœ… Packaging completed successfully"

      - name: Setup SSH Connection
        run: |
          echo "=========================================="
          echo "ðŸ” Setting up SSH connection..."
          echo "=========================================="
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "â†’ Scanning host keys for ${{ secrets.VPS_HOST }}..."
          ssh-keyscan -H -p ${{ secrets.VPS_SSH_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "âœ… SSH configured successfully"

      - name: Upload to VPS
        run: |
          echo "=========================================="
          echo "ðŸ“¤ Uploading Next.js package to VPS..."
          echo "=========================================="
          echo "â†’ Target: ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/"
          echo "â†’ Port: ${{ secrets.VPS_SSH_PORT || 22 }}"
          echo ""
          scp -v -P ${{ secrets.VPS_SSH_PORT || 22 }} laqta.tar.gz ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/
          echo ""
          echo "âœ… Upload completed successfully"

      - name: Deploy on VPS
        run: |
          echo "=========================================="
          echo "ðŸš€ Deploying Next.js on VPS..."
          echo "=========================================="
          ssh -p ${{ secrets.VPS_SSH_PORT || 22 }} ${{ secrets.VPS_SSH_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          DEPLOY_PATH="/var/www/laqta-project/laqta"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 1: Verify Strapi is running"
          echo "=========================================="
          if curl -sf http://localhost:1337/api/health > /dev/null; then
            echo "âœ… Strapi is healthy and running"
          else
            echo "âš  Warning: Strapi health check failed"
            echo "â†’ Continuing deployment (Strapi may be starting)"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 2: Backup environment file"
          echo "=========================================="
          if [ -f "$DEPLOY_PATH/.env.local" ]; then
            cp "$DEPLOY_PATH/.env.local" /tmp/.env.local.bak
            echo "âœ… .env.local backed up to /tmp/.env.local.bak"
          else
            echo "âš  No .env.local file found (first deployment?)"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 3: Prepare deployment directory"
          echo "=========================================="
          echo "â†’ Creating directory: $DEPLOY_PATH"
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          echo "â†’ Current directory: $(pwd)"
          echo "â†’ Cleaning old files (preserving node_modules and .env.local)..."
          find . -mindepth 1 -maxdepth 1 ! -name 'node_modules' ! -name '.env.local' -exec rm -rf {} +
          echo "âœ… Directory cleaned"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 4: Extract new files"
          echo "=========================================="
          echo "â†’ Extracting laqta.tar.gz..."
          tar -xzf /tmp/laqta.tar.gz
          echo "âœ… Files extracted"
          echo ""
          echo "ðŸ“‚ Deployed files:"
          ls -la

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 5: Restore environment file"
          echo "=========================================="
          if [ -f /tmp/.env.local.bak ]; then
            mv /tmp/.env.local.bak .env.local
            echo "âœ… .env.local restored"
          else
            echo "âš  No .env.local backup to restore"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 6: Start/Restart application"
          echo "=========================================="
          if [ -f "server.js" ]; then
            echo "â†’ Standalone server.js detected"
            if pm2 describe laqta > /dev/null 2>&1; then
              echo "â†’ Laqta process found, restarting..."
              pm2 restart laqta
              echo "âœ… Laqta restarted (standalone mode)"
            else
              echo "â†’ Laqta process not found, starting new..."
              pm2 start server.js --name "laqta"
              echo "âœ… Laqta started (standalone mode)"
            fi
          else
            echo "â†’ Standard Next.js build detected"
            echo "â†’ Installing production dependencies..."
            npm ci --only=production
            echo "âœ… Dependencies installed"

            if pm2 describe laqta > /dev/null 2>&1; then
              echo "â†’ Laqta process found, restarting..."
              pm2 restart laqta
              echo "âœ… Laqta restarted"
            else
              echo "â†’ Laqta process not found, starting new..."
              pm2 start npm --name "laqta" -- run start
              echo "âœ… Laqta started"
            fi
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 7: Save PM2 process list"
          echo "=========================================="
          pm2 save
          echo "âœ… PM2 process list saved"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 8: Cleanup"
          echo "=========================================="
          rm /tmp/laqta.tar.gz
          echo "âœ… Temporary files cleaned"

          echo ""
          echo "=========================================="
          echo "ðŸ“ Step 9: Verify deployment"
          echo "=========================================="
          echo "â†’ PM2 status:"
          pm2 status
          echo ""
          echo "â†’ Waiting 5 seconds for Next.js to start..."
          sleep 5
          echo "â†’ Checking frontend health..."
          if curl -sf http://localhost:3000 > /dev/null; then
            echo "âœ… Next.js frontend is responding!"
          else
            echo "âš  Health check failed (Next.js may still be starting)"
            echo "â†’ Recent PM2 logs:"
            pm2 logs laqta --lines 20 --nostream || true
          fi

          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ NEXT.JS DEPLOYMENT COMPLETED!"
          echo "=========================================="
          EOF
